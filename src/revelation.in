#!/usr/bin/env python

#
# Revelation 0.3.3 - a password manager for GNOME 2
# http://oss.codepoet.no/revelation/
# $Id$
#
# Copyright (c) 2003-2004 Erik Grinaker
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#

import sys

if "@pythondir@" not in sys.path:
	sys.path.insert(0, "@pythondir@")

import gtk, gnome, revelation, os, os.path, gobject


class Revelation(revelation.widget.App):
	"Main application class"

	def __init__(self):
		sys.excepthook = self.__cb_exception
		os.umask(0077)

		gnome.init(revelation.APPNAME, revelation.APPNAME)
		revelation.widget.App.__init__(self, revelation.APPNAME)

		self.__init_facilities()
		self.__init_ui()
		self.__init_states()


	# init methods
	def __init_ui(self):
		"Sets up the user interface elements"

		gtk.window_set_default_icon_list(
			self.items.load_icon("revelation", 48),
			self.items.load_icon("revelation", 32),
			self.items.load_icon("revelation", 24),
			self.items.load_icon("revelation", 16)
		)

		# global actions
		actiongroup = gtk.ActionGroup("global")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("menu-edit",		None,				"_Edit"),
			("menu-file",		None,				"_File"),
			("menu-help",		None,				"_Help"),
			("menu-popup-tree",	None,				""),
			("menu-view",		None,				"_View"),

			("file-changepassword",	revelation.stock.STOCK_PASSWORD_CHANGE, "Change _Password...",	None,			"Change password of current file",	lambda w: self.change_password()),
			("file-close",		gtk.STOCK_CLOSE,		"_Close",		"<Control>W",		"Close the application",		lambda w: self.quit()),
			("file-export",		revelation.stock.STOCK_EXPORT,	"_Export...",		None,			"Export data to a different format",	lambda w: self.file_export()),
			("file-import",		revelation.stock.STOCK_IMPORT,	"_Import...",		None,			"Import data from a foreign file",	lambda w: self.file_import()),
			("file-new",		gtk.STOCK_NEW,			"_New",			"<Control>N",		"Create a new file",			lambda w: self.file_new()),
			("file-open",		gtk.STOCK_OPEN,			"_Open...",		"<Control>O",		"Open a file",				lambda w: self.file_open()),
			("file-save",		gtk.STOCK_SAVE,			"_Save",		"<Control>S",		"Save data to file",			lambda w: self.file_save(self.datafile.get_file(), self.datafile.get_password())),
			("file-save-as",	gtk.STOCK_SAVE_AS,		"Save _as...",		"<Shift><Control>S",	"Save data to a different file",	lambda w: self.file_save()),

			("about",		"gnome-stock-about",		"_About",		None,			"Show info about this application",	lambda w: revelation.dialog.About(self).run()),
			("deselect-all",	None,				"_Deselect All",	"<Shift><Control>A",	"Deselect all entries",			lambda w: self.tree.unselect_all()),
			("find",		gtk.STOCK_FIND,			"_Find...",		"<Control>F",		"Search for an entry",			lambda w: self.entry_find()),
			("homepage",		gtk.STOCK_HOME,			"_Homepage",		None,			"Visit the Revelation homepage",	lambda w: gnome.url_show(revelation.URL)),
			("prefs",		gtk.STOCK_PREFERENCES,		"Prefere_nces",		None,			"Edit preferences",			lambda w: revelation.dialog.Preferences(self, self.config).run()),
			("pwgenerator",		revelation.stock.STOCK_GENERATE, "Password _Generator",	None,			"Opens a password generator",		lambda w: revelation.dialog.PasswordGenerator(self, self.config).run()),
			("select-all",		None,				"_Select All",		"<Control>A",		"Select all entries",			lambda w: self.tree.select_all()),
			("quit",		gtk.STOCK_QUIT,			"_Quit",		"<Control>Q",		"Quit the application",			lambda w: self.quit()),
		))

		actiongroup.add_toggle_actions((
			("view-passwords",	None,				"Show _passwords",	"<Control>P",		"Show passwords",			None),
			("view-searchbar",	None,				"S_earch Toolbar",	None,			"Toggle display of the search toolbar",	None),
			("view-statusbar",	None,				"_Statusbar",		None,			"Toggle display of the statusbar",	None),
			("view-toolbar",	None,				"_Main Toolbar",	None,			"Toggle display of the main toolbar",	None),
		))

		# various dynamic actions
		actiongroup = gtk.ActionGroup("dynamic")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("clip-paste",		gtk.STOCK_PASTE,		"_Paste",		"<Control>C",		"Paste entry from clipboard",		lambda w: self.clip_paste()),
			("redo",		gtk.STOCK_REDO,			"_Redo",		"<Shift><Control>Z",	"Redo the previously undone action",	lambda w: self.redo()),
			("undo",		gtk.STOCK_UNDO,			"_Undo",		"<Control>Z",		"Undo the last action",			lambda w: self.undo()),
		))

		# actions on an opened file
		actiongroup = gtk.ActionGroup("file-exists")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("file-lock",		revelation.stock.STOCK_LOCK,	"_Lock",		"<Shift><Control>L",	"Lock the current data file",		lambda w: self.file_lock()),
			("file-revert",		gtk.STOCK_REVERT_TO_SAVED,	"_Revert",		None,			"Revert to the saved copy of the file",	lambda w: self.file_revert()),
		))

		# search actions
		actiongroup = gtk.ActionGroup("find")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("find-next",		None,				"Find Ne_xt",		"<Control>G",		"Find the next search match",		lambda w: self.__entry_find(self, revelation.data.SEARCH_NEXT)),
			("find-previous",	None,				"Find Pre_vious",	"<Shift><Control>G",	"Find the previous search match",	lambda w: self.__entry_find(self, revelation.data.SEARCH_PREVIOUS)),
		))

		# optional (0 || 1 ) entry selected
		actiongroup = gtk.ActionGroup("entry-optional")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("entry-add",		revelation.stock.STOCK_ADD,	"_Add Entry...",	"<Control>Insert",	"Create a new entry",			lambda w: self.entry_add()),
		))

		self.uimanager.get_action("entry-add").set_property("is-important", gtk.TRUE)
		

		# single entry selected
		actiongroup = gtk.ActionGroup("entry-single")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("entry-edit",		revelation.stock.STOCK_EDIT,	"_Edit...",		"<Control>Return",	"Edit the selected entry",		lambda w: self.entry_edit()),
		))

		# multiple (>= 1) entries selected
		actiongroup = gtk.ActionGroup("entry-multiple")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("clip-copy",		gtk.STOCK_COPY,			"_Copy",		"<Control>C",		"Copy the selected entry to the clipboard", lambda w: self.clip_copy()),
			("clip-cut",		gtk.STOCK_CUT,			"Cut_",			"<Control>X",		"Cut the entry to the clipboard",	lambda w: self.clip_cut()),
			("entry-remove",	revelation.stock.STOCK_REMOVE,	"Re_move",		"<Control>Delete",	"Remove the selected entry",		lambda w: self.entry_remove()),
		))

		# entries can be launched
		actiongroup = gtk.ActionGroup("entry-launch")
		self.uimanager.append_action_group(actiongroup)
		actiongroup.add_actions((
			("entry-launch",	revelation.stock.STOCK_LAUNCH,	"_Launch",		"<Shift><Control>Return", "Launch the selected entry",		lambda w: self.entry_launch()),
		))

		self.uimanager.get_action("entry-launch").set_property("is-important", gtk.TRUE)


		# load ui definitions
		self.uimanager.add_ui_from_file(revelation.DIR_UI + "/menubar.xml")
		self.uimanager.add_ui_from_file(revelation.DIR_UI + "/popup-tree.xml")
		self.uimanager.add_ui_from_file(revelation.DIR_UI + "/toolbar.xml")


		# set up the menu
		self.set_menus(self.uimanager.get_widget("/menubar"))


		# set up toolbars
		self.toolbar = self.uimanager.get_widget("/toolbar-main")
		self.set_toolbar(self.toolbar)

		self.searchbar = revelation.widget.Searchbar()
		self.searchbar.button.connect("clicked", lambda w: self.__entry_find(self, string = self.searchbar.entry.get_text()))
		self.add_toolbar(self.searchbar, "searchbar", 2)


		# set up the mainarea
		self.tree = revelation.widget.Tree(self.data)
		self.tree.connect("popup", lambda w,d: self.popup(self.uimanager.get_widget("/menu-popup-tree"), d.button, d.time))
		self.tree.connect("doubleclick", lambda w,d: self.entry_edit())
		self.tree.connect("key-press-event", self.__cb_keypress_tree)
		self.tree.selection.connect("changed", lambda w: self.dataview.display_entry(self.data.get_entry(self.tree.get_active())))
		self.tree.selection.connect("changed", self.__cb_state_entry)
		scrolledwindow = revelation.widget.ScrolledWindow(self.tree)

		self.dataview = revelation.widget.DataView()
		alignment = gtk.Alignment(0.5, 0.4, 0, 0)
		alignment.add(self.dataview)

		self.hpaned = revelation.widget.HPaned(scrolledwindow, alignment, self.config.get("view/pane-position"))
		self.set_contents(self.hpaned)


	def __init_facilities(self):
		"Sets up various application facilities"

		try:
			self.config = revelation.data.Config()

		except revelation.data.ConfigError:
			revelation.dialog.Error(
				None, "Configuration error",
				"The Revelation configuration data could not be found in gconf. This indicates a fault in your installation, please re-install Revelation."
			).run()

			sys.exit(1)


		self.items = revelation.stock.ItemFactory(self)

		self.data = revelation.data.EntryStore()

		self.datafile = revelation.io.DataFile()
		self.datafile.connect("changed", self.__cb_state_file)

		self.clipboard = revelation.widget.Clipboard()

		self.entryclipboard = revelation.data.EntryClipboard()
		self.entryclipboard.connect("copy", self.__cb_state_clipboard)
		self.entryclipboard.connect("cut", self.__cb_state_clipboard)

		self.undoqueue = revelation.data.UndoQueue(self.data)
		self.undoqueue.connect("changed", self.__cb_state_undo)

		self.finder = revelation.data.EntrySearch(self.data)
		self.finder.connect("changed", self.__cb_state_find)


	def __init_states(self):
		"Sets the initial application state"

		self.set_default_size(self.config.get("view/window-width"), self.config.get("view/window-height"))
		self.move(self.config.get("view/window-position-x"), self.config.get("view/window-position-y"))
		self.connect("delete_event", lambda w,d: gtk.TRUE ^ self.quit())

		self.tree.select(None)
		self.dataview.display_info()
		self.datafile.emit("changed", None)

		self.show_all()

		self.uimanager.get_action_group("find").set_sensitive(gtk.FALSE)
		self.uimanager.get_action("undo").set_property("sensitive", gtk.FALSE)
		self.uimanager.get_action("redo").set_property("sensitive", gtk.FALSE)

		self.config.bind_widget("view/passwords", self.uimanager.get_widget("/menubar/menu-view/view-passwords"))
		self.config.bind_widget("view/searchbar", self.uimanager.get_widget("/menubar/menu-view/view-searchbar"))
		self.config.bind_widget("view/statusbar", self.uimanager.get_widget("/menubar/menu-view/view-statusbar"))
		self.config.bind_widget("view/toolbar", self.uimanager.get_widget("/menubar/menu-view/view-toolbar"))

		self.config.notify_add("view/searchbar", self.__cb_config_searchbar)
		self.config.notify_add("view/statusbar", self.__cb_config_statusbar)
		self.config.notify_add("view/toolbar", self.__cb_config_toolbar)



	# exception callback
	def __cb_exception(self, type, value, trace):
		"Callback for unhandled exceptions"

		if type == KeyboardInterrupt:
			sys.exit(1)

		traceback = revelation.util.trace_exception(type, value, trace)
		sys.stderr.write(traceback)

		if revelation.dialog.Exception(self, traceback).run() == gtk.TRUE:
			self.run()

		else:
			sys.exit(1)


	# config callbacks
	def __cb_config_searchbar(self, config, value, data):
		"Config callback for searchbar changes"

		if value == gtk.TRUE:
			self.searchbar.show()

		else:
			self.searchbar.hide()

	def __cb_config_statusbar(self, config, value, data):
		"Config callback for statusbar changes"

		if value == gtk.TRUE:
			self.statusbar.show()

		else:
			self.statusbar.hide()


	def __cb_config_toolbar(self, config, value, data):
		"Config callback for toolbar changes"

		if value == gtk.TRUE:
			self.toolbar.show()

		else:
			self.toolbar.hide()



	# callbacks for handling ui states
	def __cb_state_clipboard(self, widget, data = None):
		"Sets clipboard item sensitivity as appropriate"

		self.uimanager.get_action("clip-paste").set_property("sensitive", self.entryclipboard.has_contents())


	def __cb_state_entry(self, widget, data = None):
		"Sets state for entry-dependent ui items"

		selected = self.tree.get_selected()
		active = self.tree.get_active()

		self.uimanager.get_action_group("entry-optional").set_sensitive(len(selected) < 2)
		self.uimanager.get_action("clip-paste").set_property("sensitive",  len(selected) < 2 and self.entryclipboard.has_contents())

		self.uimanager.get_action_group("entry-single").set_sensitive(len(selected) == 1)

		self.uimanager.get_action_group("entry-multiple").set_sensitive(len(selected) > 0)


		for iter in selected:
			if self.data.get_entry(iter).can_launch() == gtk.TRUE:
				self.uimanager.get_action_group("entry-launch").set_sensitive(gtk.TRUE)
				break

		else:
			self.uimanager.get_action_group("entry-launch").set_sensitive(gtk.FALSE)


	def __cb_state_file(self, object, file):
		"Sets various states based on current file"

		self.uimanager.get_action_group("file-exists").set_sensitive(file is not None)

		if file is not None:
			self.set_title(os.path.basename(file))

			if revelation.io.file_is_local(file):
				os.chdir(os.path.dirname(file))

		else:
			self.set_title("[New file]")


	def __cb_state_find(self, widget, data = None):
		"Sets ui item states for find-related items"

		self.uimanager.get_action_group("find").set_sensitive(self.finder.string != "")


	def __cb_state_undo(self, widget, data = None):
		"Sets states for undo-related ui items"

		# update undo widgets
		action = self.uimanager.get_action("undo")

		if self.undoqueue.can_undo():
			action.set_property("label", "_Undo " + self.undoqueue.get_action(revelation.data.UNDO).name)
			action.set_property("sensitive", gtk.TRUE)

		else:
			action.set_property("label", "_Undo")
			action.set_property("sensitive", gtk.FALSE)

		# update redo widgets
		action = self.uimanager.get_action("redo")

		if self.undoqueue.can_redo():
			action.set_property("label", "_Redo " + self.undoqueue.get_action(revelation.data.REDO).name)
			action.set_property("sensitive", gtk.TRUE)

		else:
			action.set_property("label", "_Redo")
			action.set_property("sensitive", gtk.FALSE)



	# other, normal callbacks
	def __cb_keypress_tree(self, widget, data = None):
		"Handles key presses for the tree"

		# return
		if data.keyval == 65293:
			self.entry_edit()

		# insert
		elif data.keyval == 65379:
			self.entry_add()

		# delete
		elif data.keyval == 65535:
			self.entry_remove()



	# various private methods
	def __entry_find(self, parent, direction = revelation.data.SEARCH_NEXT, string = None):
		"Searches for an entry"

		if string is not None:
			self.finder.string = string

		if self.finder.string is not None:
			self.searchbar.entry.set_text(self.finder.string)

		self.finder.folders = self.config.get("search/folders")
		self.finder.casesens = self.config.get("search/casesens")
		self.finder.namedesc = self.config.get("search/namedesc")

		match = self.finder.find(self.tree.get_active(), direction)

		if match is None:
			revelation.dialog.Error(parent, "No match found", "The string you searched for did not match any entries. Try using a different search-phrase.").run()

		else:
			self.tree.select(match)


	def __file_autosave(self):
		"Autosaves the current file, due to data modification"

		if self.datafile.get_file() is None:
			return

		if not self.config.get("file/autosave"):
			return

		self.file_save(self.datafile.get_file(), self.datafile.get_password())


	def __file_load(self, file, password, datafile = None):
		"Loads data from a file into an entrystore"

		if datafile is None:
			datafile = self.datafile

		try:
			while 1:
				try:
					entrystore = datafile.load(
						file, password,
						lambda: revelation.dialog.PasswordLoad(self, file).run()
					)

					return entrystore

				except revelation.datahandler.PasswordError:
					revelation.dialog.Error(
						self, "Incorrect password",
						"The password you entered for the file'" + file + "' was not correct."
					).run()

					continue


		except revelation.datahandler.FormatError:
			self.statusbar.set_status("Open failed")
			revelation.dialog.Error(
				self, "Invalid file format",
				"The file '" + file + "' contains invalid data."
			).run()

		except revelation.entry.EntryError:
			self.statusbar.set_status("Open failed")
			revelation.dialog.Error(
				self, "Unknown data",
				"The file '" + file + "' contains unknown data. It may have been created by a future version of Revelation, try upgrading to a newer version."
			).run()

		except revelation.datahandler.VersionError:
			self.statusbar.set_status("Open failed")
			revelation.dialog.Error(
				self, "Unknown data version",
				"The file '" + file + "' has a future version number - upgrade Revelation to a more recent version to open it."
			).run()

		#except revelation.io.DetectError:
		#	self.statusbar.set_status("Open failed")
		#	revelation.dialog.Error(
		#		self, "Filetype autodetection failed",
		#		"The format of the file '" + file + "' could not be detected automatically. It may still be possible to open the file, try specifying the file type manually."
		#	).run()

		except IOError:
			self.statusbar.set_status("Open failed")
			revelation.dialog.Error(
				self, "Unable to open file",
				"The file '" + file + "' could not be opened. Make sure that the file exists, and that you have the proper permissions to open it."
			).run()


	def __file_save(self, file, password, datafile = None):
		"Saves data to a file"

		if datafile is None:
			datafile = self.datafile

		try:
			if revelation.io.file_normpath(str(datafile)) != revelation.io.file_normpath(file) and revelation.io.file_exists(file):
				revelation.dialog.FileOverwrite(self, file).run()

			if datafile.get_handler() is not None and datafile.get_handler().encryption == gtk.TRUE:
				if password is None:
					password = revelation.dialog.PasswordSave(self, file).run()

			else:
				revelation.dialog.FileExportInsecure(self).run()

			datafile.save(self.data, file, password)

			return gtk.TRUE

		except IOError:
			revelation.dialog.Error(self, "Unable to write to file", "The file '" + file + "' could not be opened for writing. Make sure that you have the proper permissions to write to it.").run()
			self.statusbar.set_status("Save failed")

			raise
			return gtk.FALSE


	def __save_changes(self, dialog):
		"Asks the user if she wants to save her changes"

		try:
			if not self.data.changed:
				return gtk.TRUE

			if dialog(self).run() == gtk.TRUE:
				return self.file_save(self.datafile.get_file(), self.datafile.get_password())

			return gtk.TRUE

		except revelation.CancelError:
			return gtk.FALSE



	# public methods
	def change_password(self):
		"Changes the password of the current data file"

		try:
			dialog = revelation.dialog.PasswordChange(self, self.datafile.get_password())
			self.datafile.set_password(dialog.run())

			self.__file_autosave()
			self.statusbar.set_status("Password changed")

		except revelation.CancelError:
			self.statusbar.set_status("Password change cancelled")

		dialog.destroy()


	def clip_copy(self):
		"Copies selected entries to the clipboard"

		iters = self.data.filter_parents(self.tree.get_selected())
		self.entryclipboard.copy(self.data, iters)


	def clip_cut(self):
		"Cuts selected entries to the clipboard"

		iters = self.data.filter_parents(self.tree.get_selected())
		self.undoqueue.add_action(revelation.data.UNDO_ACTION_CUT, iters)
		self.entryclipboard.cut(self.data, iters)
		self.__file_autosave()
		self.tree.unselect_all()


	def clip_paste(self):
		"Pastes entries from the clipboard"

		if not self.entryclipboard.has_contents():
			return

		iters = self.entryclipboard.paste(self.data, self.tree.get_active())
		self.undoqueue.add_action(revelation.data.UNDO_ACTION_PASTE, iters)
		self.__file_autosave()
		self.tree.select(iters[0])


	def entry_add(self):
		"Adds an entry"

		try:
			dialog = revelation.dialog.EntryEdit(self, "Add entry")
			dialog.set_field_data(revelation.entry.UsernameField, self.data.get_popular_values(revelation.entry.UsernameField))
			entry = dialog.run()
			iter = self.data.add_entry(self.tree.get_active(), entry)

			self.undoqueue.add_action(revelation.data.UNDO_ACTION_ADD, iter)
			self.__file_autosave()

			self.tree.select(iter)
			self.statusbar.set_status("Added entry '" + entry.name + "'")

		except revelation.CancelError:
			self.statusbar.set_status("Add entry cancelled")


	def entry_edit(self):
		"Edits an entry"

		iter = self.tree.get_active()

		if iter is None:
			return

		try:
			entry = self.data.get_entry(iter)
			dialog = revelation.dialog.EntryEdit(self, "Edit entry", entry)
			dialog.set_field_data(revelation.entry.UsernameField, self.data.get_popular_values(revelation.entry.UsernameField))

			if type(entry) == revelation.entry.FolderEntry and self.data.iter_n_children(iter) > 0:
				dialog.set_typechange_allowed(gtk.FALSE)

			newentry = dialog.run()
			self.data.update_entry(iter, newentry)
			self.undoqueue.add_action(revelation.data.UNDO_ACTION_EDIT, iter, entry)

			self.__file_autosave()
			self.tree.select(iter)
			self.statusbar.set_status("Updated entry '" + newentry.name + "'")

		except revelation.CancelError:
			self.statusbar.set_status("Update entry cancelled")


	def entry_find(self):
		"Searches for an entry"

		dialog = revelation.dialog.Find(self, self.config)
		dialog.entry_phrase.set_text(self.finder.string)
		dialog.dropdown.set_type(self.finder.type)

		while 1:
			response = dialog.run()
			self.finder.string = dialog.entry_phrase.get_text()
			self.finder.type = dialog.dropdown.get_type()

			if response == revelation.dialog.RESPONSE_NEXT:
				self.__entry_find(dialog, revelation.data.SEARCH_NEXT)

			elif response == revelation.dialog.RESPONSE_PREVIOUS:
				self.__entry_find(dialog, revelation.data.SEARCH_PREV)

			else:
				dialog.destroy()
				break


	def entry_launch(self):
		"Launches an entry"

		iters = self.tree.get_selected()

		for iter in iters:
			try:
				entry = self.data.get_entry(iter)

				if entry.can_launch():

					secretfield = entry.get_secret()
					if secretfield is not None:
						self.clipboard.set_text(secretfield.value)

					entry.launch()

				self.statusbar.set_status("Launched entry '" + entry.name + "'")

			except revelation.entry.LaunchDataError:
				revelation.dialog.Error(self, "Missing launcher data", "The entry '" + entry.name + "' does not have all the data required to launch it.").run()

			except revelation.entry.LaunchFormatError:
				revelation.dialog.Error(self, "Invalid launcher format", "The launch command for '" + entry.typename + "' entries is invalid, please correct this in the preferences.").run()



	def entry_remove(self):
		"Removes one or more entries"

		iters = self.tree.get_selected()

		if len(iters) == 0:
			return

		entries = self.data.get_entries(iters)


		try:
			if revelation.dialog.EntryRemove(self, entries).run() != gtk.TRUE:
				raise revelation.CancelError

			if len(iters) == 1:
				statustext = "Removed entry '" + entries[0].name + "'"

			else:
				statustext = "Removed " + str(len(entries)) + " entries"

			iters = self.data.filter_parents(iters)
			self.undoqueue.add_action(revelation.data.UNDO_ACTION_REMOVE, iters)

			for iter in iters:
				self.data.remove_entry(iter)

			self.__file_autosave()
			self.tree.unselect_all()
			self.statusbar.set_status(statustext)

		except revelation.CancelError:
			self.statusbar.set_status("Remove entry cancelled")


	def file_export(self):
		"Exports data to a foreign file format"

		try:
			file, handler = revelation.dialog.ExportFileSelector(self).run()
			datafile = revelation.io.DataFile(handler)
			self.__file_save(file, None, datafile)
			self.statusbar.set_status("Data exported to " + datafile.get_file())

		except revelation.CancelError:
			self.statusbar.set_status("Export cancelled")


	def file_import(self):
		"Imports data from a foreign file"

		try:
			file, handler = revelation.dialog.ImportFileSelector(self).run()
			datafile = revelation.io.DataFile(handler)
			entrystore = self.__file_load(file, None, datafile)

			if entrystore is None:
				return

			iters = self.data.import_entrystore(entrystore)
			self.undoqueue.add_action(revelation.data.UNDO_ACTION_IMPORT, iters)
			self.__file_autosave()
			self.statusbar.set_status("Data imported from " + file)

		except revelation.CancelError:
			self.statusbar.set_status("Import cancelled")


	def file_lock(self):
		"Locks the current data file"

		if self.datafile.get_password() is None:
			return

		iter = self.tree.get_active()
		self.tree.set_model(None)
		self.dataview.clear()
		self.statusbar.set_status("File locked")

		dialog = revelation.dialog.PasswordLock(self)

		while 1:
			if dialog.run() == self.datafile.get_password():
				break

			else:
				revelation.dialog.Error(
					dialog, "Incorrect password",
					"The password you entered was not correct, please try again."
				).run()


		dialog.destroy()

		self.tree.set_model(self.data)
		self.tree.select(iter)
		self.statusbar.set_status("File unlocked")


	def file_new(self):
		"Opens a new file"

		if not self.__save_changes(revelation.dialog.FileChangedNew):
			self.statusbar.set_status("New file cancelled")
			return

		self.data.clear()
		self.datafile.close()
		self.statusbar.set_status("New file created")


	def file_open(self, file = None, password = None):
		"Opens a data file"

		try:
			if not self.__save_changes(revelation.dialog.FileChangedOpen):
				raise revelation.CancelError

			if file is None:
				file = revelation.dialog.OpenFileSelector(self).run()

			entrystore = self.__file_load(file, password)

			if entrystore is None:
				return

			self.data.replace_entrystore(entrystore)
			self.statusbar.set_status("Opened file " + file)


		except revelation.CancelError:
			self.statusbar.set_status("Open cancelled")


	def file_revert(self):
		"Reverts to the saved version of the file"

		if not self.__save_changes(revelation.dialog.FileChangedRevert):
			self.statusbar.set_status("Revert cancelled")
			return gtk.FALSE

		self.data.changed = gtk.FALSE
		self.file_open(self.datafile.get_file(), self.datafile.get_password())


	def file_save(self, file = None, password = None):
		"Saves a data file"

		try:
			if file is None:
				file = revelation.dialog.SaveFileSelector(self).run()

			if self.__file_save(file, password) == True:
				self.statusbar.set_status("Data saved to file " + file)
				return True

		except revelation.CancelError:
			self.statusbar.set_status("Save cancelled")
			return False


	def quit(self):
		"Quits the application"

		if not self.__save_changes(revelation.dialog.FileChangedQuit):
			self.statusbar.set_status("Quit cancelled")
			return gtk.FALSE

		width, height = self.get_size()
		self.config.set("view/window-width", width)
		self.config.set("view/window-height", height)

		x, y = self.get_position()
		self.config.set("view/window-position-x", x)
		self.config.set("view/window-position-y", y)

		self.config.set("view/pane-position", self.hpaned.get_position())

		gtk.main_quit()
		return gtk.TRUE


	def redo(self):
		"Redo the previously undone operation"

		if not self.undoqueue.can_redo():
			return

		action = self.undoqueue.get_action(revelation.data.REDO)
		iters = self.undoqueue.redo()

		if len(iters) > 0:
			self.tree.select(iters[0])

		else:
			self.tree.unselect_all()

		self.__file_autosave()
		self.statusbar.set_status(action.name.capitalize() + " redone")


	def run(self):
		"Run the application"

		if len(sys.argv) > 1:
			self.file_open(revelation.io.file_normpath(sys.argv[1]))

		elif self.config.get("file/autoload") and self.config.get("file/autoload_file") != "":
			self.file_open(self.config.get("file/autoload_file"))

		gtk.main()


	def undo(self):
		"Attempts to undo the previous operation"

		if not self.undoqueue.can_undo():
			return

		action = self.undoqueue.get_action()
		iters = self.undoqueue.undo()

		if len(iters) > 0:
			self.tree.select(iters[0])

		else:
			self.tree.unselect_all()

		self.__file_autosave()
		self.statusbar.set_status(action.name.capitalize() + " undone")



if __name__ == "__main__":
	Revelation().run()


